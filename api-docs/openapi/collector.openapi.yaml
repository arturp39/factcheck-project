openapi: 3.0.3
info:
  title: FactCheck Collector API
  version: "1.0.0"
  description: >
    Admin, ingestion, and internal APIs for source ingestion and article search/content.
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
servers:
  - url: https://factcheck-news-collector-804697237544.us-central1.run.app
    description: Cloud Run collector
security: []
tags:
  - name: ingestion
    description: Trigger and monitor ingestion runs
  - name: sources
    description: Manage publishers and source endpoints
  - name: internal-articles
    description: Internal search and content access
paths:
  /ingestion/run:
    post:
      tags: [ingestion]
      summary: Trigger ingestion for all enabled sources
      operationId: triggerIngestionAll
      parameters:
        - $ref: '#/components/parameters/CorrelationIdQuery'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestionRunRequest'
            examples:
              withCorrelation:
                value:
                  correlationId: "4f2c9c2e-5d43-4c31-8f0d-9b9b6a4c4e6e"
      responses:
        "202":
          description: Ingestion started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionRunStartResponse'
        "409":
          description: Run already in progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionRunStartResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /ingestion/task:
    post:
      tags: [ingestion]
      summary: Handle an ingestion task (internal)
      operationId: handleIngestionTask
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestionTaskRequest'
      responses:
        "200":
          description: Task accepted
        "204":
          description: Invalid task payload acknowledged
        "400":
          $ref: '#/components/responses/BadRequest'
  /admin/ingestion/logs:
    get:
      tags: [ingestion]
      summary: List ingestion logs
      operationId: listIngestionLogs
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Size'
      responses:
        "200":
          description: Paginated ingestion logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionLogPageResponse'
              examples:
                page:
                  value:
                    page: 0
                    size: 2
                    totalElements: 12
                    totalPages: 6
                    items:
                      - id: 10
                        sourceEndpointId: 3
                        sourceEndpointName: "BBC News - World"
                        publisherId: 1
                        publisherName: "BBC News"
                        startedAt: "2025-12-19T08:00:00Z"
                        completedAt: "2025-12-19T08:00:14Z"
                        articlesFetched: 25
                        articlesProcessed: 25
                        articlesFailed: 0
                        status: "SUCCESS"
                        correlationId: "4f2c9c2e-5d43-4c31-8f0d-9b9b6a4c4e6e"
                      - id: 9
                        sourceEndpointId: 2
                        sourceEndpointName: "NPR - Top Stories"
                        publisherId: 2
                        publisherName: "NPR"
                        startedAt: "2025-12-19T07:40:00Z"
                        completedAt: "2025-12-19T07:40:20Z"
                        articlesFetched: 30
                        articlesProcessed: 28
                        articlesFailed: 2
                        status: "PARTIAL"
                        correlationId: "7b1f7e22-2d2f-4a65-8e60-6e9b9a6c64d0"
        "400":
          $ref: '#/components/responses/BadRequest'
  /admin/ingestion/runs/{id}:
    get:
      tags: [ingestion]
      summary: Get an ingestion run
      operationId: getIngestionRun
      parameters:
        - $ref: '#/components/parameters/RunId'
      responses:
        "200":
          description: Ingestion run
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionRunDetailResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /admin/ingestion/runs/{id}/abort:
    post:
      tags: [ingestion]
      summary: Abort an ingestion run
      operationId: abortIngestionRun
      parameters:
        - $ref: '#/components/parameters/RunId'
        - in: query
          name: reason
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Ingestion run aborted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionRunDetailResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /admin/sources:
    get:
      tags: [sources]
      summary: List sources
      operationId: listSources
      responses:
        "200":
          description: Sources
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SourceResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
    post:
      tags: [sources]
      summary: Create a source endpoint
      operationId: createSource
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SourceCreateRequest'
            examples:
              rss:
                value:
                  publisherName: "Reuters"
                  kind: "RSS"
                  displayName: "Reuters - Top News"
                  rssUrl: "https://feeds.reuters.com/reuters/topNews"
                  enabled: true
                  fetchIntervalMinutes: 15
      responses:
        "200":
          description: Created source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SourceResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /admin/sources/{id}:
    patch:
      tags: [sources]
      summary: Update a source endpoint
      operationId: updateSource
      parameters:
        - $ref: '#/components/parameters/SourcePathId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SourceUpdateRequest'
            examples:
              disable:
                value:
                  enabled: false
      responses:
        "200":
          description: Updated source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SourceResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /admin/sources/{id}/disable:
    post:
      tags: [sources]
      summary: Disable a source endpoint
      operationId: disableSource
      parameters:
        - $ref: '#/components/parameters/SourcePathId'
      responses:
        "200":
          description: Source disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SourceResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /admin/sources/{id}/enable:
    post:
      tags: [sources]
      summary: Enable a source endpoint
      operationId: enableSource
      parameters:
        - $ref: '#/components/parameters/SourcePathId'
      responses:
        "200":
          description: Source enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SourceResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /internal/articles/search:
    post:
      tags: [internal-articles]
      summary: Vector search for article chunks
      operationId: searchArticleChunks
      parameters:
        - $ref: '#/components/parameters/CorrelationIdHeader'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /internal/articles/{id}:
    get:
      tags: [internal-articles]
      summary: Get article metadata
      operationId: getArticleMetadata
      parameters:
        - $ref: '#/components/parameters/ArticleId'
      responses:
        "200":
          description: Article metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArticleMetadataResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /internal/articles/{id}/content:
    get:
      tags: [internal-articles]
      summary: Get article content
      operationId: getArticleContent
      parameters:
        - $ref: '#/components/parameters/ArticleId'
        - $ref: '#/components/parameters/CorrelationIdHeader'
      responses:
        "200":
          description: Article content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArticleContentResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /actuator/health:
    get:
      summary: Health check
      operationId: collectorHealth
      responses:
        "200":
          description: Service is up
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  parameters:
    CorrelationIdQuery:
      in: query
      name: correlationId
      schema:
        type: string
        format: uuid
      required: false
      description: Optional UUID correlation ID; autogenerated if omitted.
    CorrelationIdHeader:
      in: header
      name: X-Correlation-Id
      schema:
        type: string
        format: uuid
      required: false
      description: Optional UUID correlation ID; autogenerated if omitted.
    Page:
      in: query
      name: page
      schema:
        type: integer
        minimum: 0
        default: 0
    Size:
      in: query
      name: size
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 20
    SourcePathId:
      in: path
      name: id
      required: true
      schema:
        type: integer
        format: int64
    RunId:
      in: path
      name: id
      required: true
      schema:
        type: integer
        format: int64
    ArticleId:
      in: path
      name: id
      required: true
      schema:
        type: integer
        format: int64
  responses:
    BadRequest:
      description: Validation or domain error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            timestamp: "2025-12-19T08:00:00Z"
            status: 400
            error: "Bad Request"
            message: "page must be >= 0"
            path: "/admin/ingestion/logs"
            correlationId: "4f2c9c2e-5d43-4c31-8f0d-9b9b6a4c4e6e"
  schemas:
    ErrorResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        status:
          type: integer
        error:
          type: string
        message:
          type: string
        path:
          type: string
        correlationId:
          type: string
    IngestionRunRequest:
      type: object
      properties:
        correlationId:
          type: string
          nullable: true
          format: uuid
    IngestionTaskRequest:
      type: object
      properties:
        runId: { type: integer, format: int64 }
        sourceEndpointId: { type: integer, format: int64 }
        correlationId: { type: string }
      required: [runId, sourceEndpointId]
    IngestionRunStartResponse:
      type: object
      properties:
        runId: { type: integer, format: int64, nullable: true }
        correlationId: { type: string, nullable: true }
        tasksEnqueued: { type: integer }
        status: { type: string, enum: [RUNNING, COMPLETED, PARTIAL, FAILED] }
      required: [tasksEnqueued, status]
    IngestionRunDetailResponse:
      type: object
      properties:
        id: { type: integer, format: int64 }
        startedAt: { type: string, format: date-time }
        completedAt: { type: string, format: date-time, nullable: true }
        status: { type: string, enum: [RUNNING, COMPLETED, PARTIAL, FAILED] }
        correlationId: { type: string }
      required: [id, startedAt, status, correlationId]
    IngestionRunResponse:
      type: object
      properties:
        id: { type: integer, format: int64 }
        sourceEndpointId: { type: integer, format: int64 }
        sourceEndpointName: { type: string }
        publisherId: { type: integer, format: int64 }
        publisherName: { type: string }
        startedAt: { type: string, format: date-time }
        completedAt: { type: string, format: date-time, nullable: true }
        articlesFetched: { type: integer }
        articlesProcessed: { type: integer }
        articlesFailed: { type: integer }
        status: { type: string, enum: [STARTED, PROCESSING, SUCCESS, PARTIAL, FAILED, SKIPPED] }
        errorDetails: { type: string, nullable: true }
        correlationId: { type: string }
      required: [id, sourceEndpointId, startedAt, articlesFetched, articlesProcessed, articlesFailed, status, correlationId]
    IngestionLogPageResponse:
      type: object
      properties:
        page: { type: integer }
        size: { type: integer }
        totalElements: { type: integer, format: int64 }
        totalPages: { type: integer }
        items:
          type: array
          items:
            $ref: '#/components/schemas/IngestionRunResponse'
      required: [page, size, totalElements, totalPages, items]
    SourceCreateRequest:
      type: object
      description: publisherName is required if publisherId is not provided.
      required: [kind, displayName]
      properties:
        publisherId: { type: integer, format: int64 }
        publisherName: { type: string }
        countryCode: { type: string }
        websiteUrl: { type: string }
        kind: { type: string, enum: [RSS, API] }
        displayName: { type: string }
        rssUrl: { type: string }
        apiProvider: { type: string }
        apiQuery: { type: string }
        enabled: { type: boolean }
        fetchIntervalMinutes: { type: integer }
    SourceUpdateRequest:
      type: object
      description: publisherName is required if publisherId is not provided.
      properties:
        publisherId: { type: integer, format: int64 }
        publisherName: { type: string }
        countryCode: { type: string }
        websiteUrl: { type: string }
        kind: { type: string, enum: [RSS, API] }
        displayName: { type: string }
        rssUrl: { type: string }
        apiProvider: { type: string }
        apiQuery: { type: string }
        enabled: { type: boolean }
        fetchIntervalMinutes: { type: integer }
    SourceResponse:
      type: object
      properties:
        id: { type: integer, format: int64 }
        publisherId: { type: integer, format: int64 }
        publisherName: { type: string }
        kind: { type: string, enum: [RSS, API] }
        displayName: { type: string }
        rssUrl: { type: string, nullable: true }
        apiProvider: { type: string, nullable: true }
        apiQuery: { type: string, nullable: true }
        enabled: { type: boolean }
        fetchIntervalMinutes: { type: integer }
        lastFetchedAt: { type: string, format: date-time, nullable: true }
        lastSuccessAt: { type: string, format: date-time, nullable: true }
        failureCount: { type: integer }
        robotsDisallowed: { type: boolean }
        blockedUntil: { type: string, format: date-time, nullable: true }
        blockReason: { type: string, nullable: true }
        blockCount: { type: integer }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
      required: [id, publisherId, publisherName, kind, displayName, enabled, fetchIntervalMinutes, failureCount, robotsDisallowed, blockCount, createdAt, updatedAt]
    SearchFilters:
      type: object
      properties:
        sourceName:
          type: array
          items:
            type: string
        publishedAfter:
          type: string
          format: date-time
        publishedBefore:
          type: string
          format: date-time
    SearchRequest:
      type: object
      required: [embedding]
      properties:
        embedding:
          type: array
          description: Embedding vector; length must equal search.embedding-dimension (default 768).
          items:
            type: number
            format: float
          minItems: 1
        limit:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
        minScore:
          type: number
          format: float
          minimum: 0
          maximum: 1
          default: 0.7
        filters:
          $ref: '#/components/schemas/SearchFilters'
    ChunkResult:
      type: object
      properties:
        text: { type: string }
        articleId: { type: integer, format: int64 }
        articleUrl: { type: string }
        articleTitle: { type: string }
        sourceName: { type: string }
        publishedDate: { type: string, format: date-time }
        chunkIndex: { type: integer }
        score: { type: number, format: float }
    SearchResponse:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/ChunkResult'
        totalFound: { type: integer }
        executionTimeMs: { type: integer }
        correlationId: { type: string, nullable: true }
      required: [results, totalFound, executionTimeMs]
    ArticleMetadataResponse:
      type: object
      properties:
        id: { type: integer, format: int64 }
        publisherId: { type: integer, format: int64 }
        publisherName: { type: string }
        sourceEndpointId: { type: integer, format: int64 }
        sourceEndpointName: { type: string }
        canonicalUrl: { type: string }
        title: { type: string }
        publishedDate: { type: string, format: date-time, nullable: true }
        chunkCount: { type: integer }
        status: { type: string }
        weaviateIndexed: { type: boolean }
    ArticleContentResponse:
      type: object
      properties:
        articleId: { type: integer, format: int64 }
        publisherId: { type: integer, format: int64 }
        publisherName: { type: string }
        sourceEndpointId: { type: integer, format: int64 }
        sourceEndpointName: { type: string }
        canonicalUrl: { type: string }
        title: { type: string }
        publishedDate: { type: string, format: date-time, nullable: true }
        content: { type: string }
    HealthResponse:
      type: object
      properties:
        status: { type: string }
        components:
          type: object
          additionalProperties: true

