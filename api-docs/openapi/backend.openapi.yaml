openapi: 3.0.3
info:
  title: FactCheck Backend API
  version: "1.0.0"
  description: >
    HTTP API for claim verification, evidence retrieval, follow-ups, and bias analysis.
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
servers:
  - url: https://factcheck-backend-804697237544.us-central1.run.app
    description: Cloud Run backend
security:
  - bearerAuth: []
tags:
  - name: auth
    description: Authentication (JWT)
  - name: claims
    description: Claim verification and retrieval
paths:
  /api/auth/login:
    post:
      tags: [auth]
      summary: Login
      operationId: login
      description: Returns a JWT token for API access.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              basic:
                value:
                  username: "admin"
                  password: "change_me"
      responses:
        "200":
          description: Authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        "401":
          description: Invalid credentials
  /api/auth/register:
    post:
      tags: [auth]
      summary: Register
      operationId: register
      description: Creates a user and returns a JWT token.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
            examples:
              basic:
                value:
                  username: "user1"
                  password: "change_me"
      responses:
        "200":
          description: Registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        "401":
          description: Invalid credentials
  /api/claims/verify:
    post:
      tags: [claims]
      summary: Verify a claim
      description: Triggers embedding + vector search + LLM fact-check and stores the result. Requires JWT (USER or ADMIN).
      operationId: verifyClaim
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyRequest'
            examples:
              basic:
                value:
                  claim: "The Eiffel Tower is taller than 400 meters."
      responses:
        "200":
          description: Claim verified successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyResponse'
              examples:
                ok:
                  value:
                    correlationId: "b0fa3ed7-9589-4ab5-91a4-6101b22e3c5d"
                    claimId: 42
                    claim: "The Eiffel Tower is taller than 400 meters."
                    verdict: "false"
                    explanation: "The Eiffel Tower is 330m tall including antennas."
                    evidence:
                      - title: "Eiffel Tower Facts"
                        source: "wikipedia"
                        snippet: "Height 330 meters including antennas."
        "400":
          $ref: '#/components/responses/BadRequest'
  /api/claims:
    get:
      tags: [claims]
      summary: List claim logs
      operationId: listClaims
      description: Requires JWT (USER or ADMIN).
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
        - in: query
          name: page
          schema:
            type: integer
            minimum: 0
            default: 0
        - in: query
          name: size
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        "200":
          description: Paginated claims
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimsPageResponse'
              examples:
                page:
                  value:
                    correlationId: "a1"
                    page: 0
                    size: 2
                    totalElements: 25
                    totalPages: 13
                    items:
                      - claimId: 41
                        claim: "The Moon has no gravity."
                        createdAt: "2025-12-18T08:22:01Z"
                        verdict: "false"
                        explanation: "Moon has 1/6th Earth gravity."
                      - claimId: 40
                        claim: "Water boils at 100C at sea level."
                        createdAt: "2025-12-18T07:55:11Z"
                        verdict: "true"
                        explanation: "Boiling point 100C at 1 atm."
        "400":
          $ref: '#/components/responses/BadRequest'
  /api/claims/{id}:
    get:
      tags: [claims]
      summary: Get a claim
      operationId: getClaim
      description: Requires JWT (USER or ADMIN).
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
        - $ref: '#/components/parameters/ClaimId'
      responses:
        "200":
          description: Claim details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /api/claims/{id}/evidence:
    get:
      tags: [claims]
      summary: Re-run evidence search for a claim
      operationId: getClaimEvidence
      description: Requires JWT (USER or ADMIN).
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
        - $ref: '#/components/parameters/ClaimId'
      responses:
        "200":
          description: Evidence list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvidenceResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /api/claims/{id}/history:
    get:
      tags: [claims]
      summary: Get claim history (follow-ups + evidence)
      operationId: getClaimHistory
      description: Requires JWT (USER or ADMIN).
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
        - $ref: '#/components/parameters/ClaimId'
      responses:
        "200":
          description: Claim history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimHistoryResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /api/claims/{id}/followup:
    post:
      tags: [claims]
      summary: Ask a follow-up question
      operationId: followupClaim
      description: Requires JWT (USER or ADMIN).
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
        - $ref: '#/components/parameters/ClaimId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FollowupRequest'
            examples:
              basic:
                value:
                  question: "What sources did you use?"
      responses:
        "200":
          description: Follow-up answer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FollowupResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /api/claims/{id}/bias:
    post:
      tags: [claims]
      summary: Bias analysis for a claim
      operationId: biasClaim
      description: Requires JWT (USER or ADMIN).
      parameters:
        - $ref: '#/components/parameters/CorrelationId'
        - $ref: '#/components/parameters/ClaimId'
      responses:
        "200":
          description: Bias analysis text
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BiasResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
  /actuator/health:
    get:
      summary: Health check
      operationId: backendHealth
      description: Requires JWT with ADMIN role.
      responses:
        "200":
          description: Service is up
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        "400":
          $ref: '#/components/responses/BadRequest'
        "503":
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "500":
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    CorrelationId:
      in: header
      name: X-Correlation-Id
      required: false
      description: Client-supplied correlation ID; autogenerated if omitted.
      schema:
        type: string
    ClaimId:
      in: path
      name: id
      required: true
      schema:
        type: integer
        format: int64
  responses:
    BadRequest:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            empty-claim:
              value:
                timestamp: "2025-12-19T08:00:00Z"
                status: 400
                error: "Bad Request"
                message: "Claim must not be empty."
                path: "/api/claims/verify"
                correlationId: "abc-123"
  schemas:
    EvidenceItem:
      type: object
      properties:
        title:
          type: string
        source:
          type: string
        publishedAt:
          type: string
          format: date-time
        snippet:
          type: string
      required: [title, source]
    VerifyRequest:
      type: object
      required: [claim]
      properties:
        claim:
          type: string
          maxLength: 400
    VerifyResponse:
      type: object
      properties:
        correlationId:
          type: string
        claimId:
          type: integer
          format: int64
        claim:
          type: string
        verdict:
          type: string
          enum: ["true", "false", "mixed", "unclear"]
        explanation:
          type: string
        evidence:
          type: array
          items:
            $ref: '#/components/schemas/EvidenceItem'
      required: [correlationId, claimId, claim, verdict, explanation, evidence]
    ClaimSummary:
      type: object
      properties:
        claimId:
          type: integer
          format: int64
        claim:
          type: string
        createdAt:
          type: string
          format: date-time
        verdict:
          type: string
        explanation:
          type: string
    ClaimsPageResponse:
      type: object
      properties:
        correlationId:
          type: string
        page:
          type: integer
        size:
          type: integer
        totalElements:
          type: integer
          format: int64
        totalPages:
          type: integer
        items:
          type: array
          items:
            $ref: '#/components/schemas/ClaimSummary'
      required: [correlationId, page, size, totalElements, totalPages, items]
    ClaimResponse:
      type: object
      properties:
        correlationId:
          type: string
        claimId:
          type: integer
          format: int64
        claim:
          type: string
        createdAt:
          type: string
          format: date-time
        verdict:
          type: string
        explanation:
          type: string
        biasAnalysis:
          type: string
        modelAnswer:
          type: string
      required: [correlationId, claimId, claim, createdAt, verdict, explanation]
    FollowupItem:
      type: object
      properties:
        question:
          type: string
        answer:
          type: string
        createdAt:
          type: string
          format: date-time
      required: [question, answer, createdAt]
    EvidenceResponse:
      type: object
      properties:
        correlationId:
          type: string
        claimId:
          type: integer
          format: int64
        claim:
          type: string
        evidence:
          type: array
          items:
            $ref: '#/components/schemas/EvidenceItem'
      required: [correlationId, claimId, claim, evidence]
    ClaimHistoryResponse:
      type: object
      properties:
        correlationId:
          type: string
        claimId:
          type: integer
          format: int64
        claim:
          type: string
        createdAt:
          type: string
          format: date-time
        verdict:
          type: string
        explanation:
          type: string
        biasAnalysis:
          type: string
        evidence:
          type: array
          items:
            $ref: '#/components/schemas/EvidenceItem'
        followups:
          type: array
          items:
            $ref: '#/components/schemas/FollowupItem'
      required: [correlationId, claimId, claim, createdAt, evidence, followups]
    FollowupRequest:
      type: object
      required: [question]
      properties:
        question:
          type: string
    FollowupResponse:
      type: object
      properties:
        correlationId:
          type: string
        claimId:
          type: integer
          format: int64
        claim:
          type: string
        verdict:
          type: string
        explanation:
          type: string
        biasAnalysis:
          type: string
        evidence:
          type: array
          items:
            $ref: '#/components/schemas/EvidenceItem'
        question:
          type: string
        answer:
          type: string
      required:
        [correlationId, claimId, claim, verdict, explanation, evidence, question, answer]
    BiasResponse:
      type: object
      properties:
        correlationId:
          type: string
        claimId:
          type: integer
          format: int64
        claim:
          type: string
        verdict:
          type: string
        biasAnalysis:
          type: string
      required: [correlationId, claimId, claim, verdict, biasAnalysis]
    ErrorResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        status:
          type: integer
        error:
          type: string
        message:
          type: string
        path:
          type: string
        correlationId:
          type: string
    HealthResponse:
      type: object
      properties:
        status:
          type: string
    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
        password:
          type: string
    RegisterRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
        password:
          type: string
    AuthResponse:
      type: object
      properties:
        token:
          type: string
        tokenType:
          type: string
      required: [token, tokenType]

