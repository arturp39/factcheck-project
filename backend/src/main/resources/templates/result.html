<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>FactCheck Result</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body class="page">

<header class="header">
    <div class="header-title">FactCheck Assistant</div>
    <div class="header-subtitle">
        Result of the last fact-check request.
    </div>
    <div class="header-actions">
        <a href="/auth/logout" class="link-logout">Sign out</a>
    </div>
</header>

<main class="main">

    <a href="/" class="link-back">&larr; New claim</a>

    <!-- Error (if backend-side issues occurred) -->
    <div th:if="${error}" class="alert alert-error" th:text="${error}">
        Error message
    </div>

    <!-- Claim bubble -->
    <section class="chat-block">
        <div class="chat-label">You</div>
        <div class="chat-bubble chat-bubble-user">
            <p th:text="${claim}">Claim text</p>
        </div>
    </section>

    <!-- Assistant response: verdict + explanation + bias button/section -->
    <section class="chat-block">
        <div class="chat-label">Assistant</div>
        <div class="chat-bubble chat-bubble-assistant">

            <div class="verdict-block">
                <span class="verdict-label">Verdict:</span>
                <span class="verdict-value verdict-unknown"
                      th:text="${verdict} ?: 'unclear'"
                      th:classappend="${verdict} == 'true' ? ' verdict-true' :
                                      (${verdict} == 'false' ? ' verdict-false' :
                                      (${verdict} == 'mixed' ? ' verdict-mixed' :
                                       ' verdict-unknown'))">
                    unclear
                </span>
            </div>

            <div class="assistant-section">
                <h3 class="assistant-section-title">Explanation</h3>
                <p class="assistant-text" th:text="${explanation} ?: 'No explanation available.'">
                    Explanation text
                </p>
            </div>

            <!-- Bias & limitations (Prompt 3) controlled by button -->
            <div class="assistant-section">
                <h3 class="assistant-section-title">Evidence bias &amp; limitations</h3>

                <!-- If we already have biasAnalysis -> show it -->
                <div th:if="${biasAnalysis != null}">
                    <p class="assistant-text" th:text="${biasAnalysis}">
                        Bias analysis text
                    </p>

                    <!-- Optional: allow re-run -->
                    <form th:if="${claimId}"
                          th:action="@{'/bias/' + ${claimId}}"
                          method="post"
                          class="form-inline">
                        <button type="submit" class="btn btn-secondary">
                            Re-analyze bias
                        </button>
                    </form>
                </div>

                <!-- If no biasAnalysis yet -> show button only -->
                <div th:if="${biasAnalysis == null}">
                    <p class="muted">
                        The assistant has not analyzed source bias and limitations yet.
                    </p>
                    <form th:if="${claimId}"
                          th:action="@{'/bias/' + ${claimId}}"
                          method="post"
                          class="form-inline">
                        <button type="submit" class="btn btn-secondary">
                            Analyze bias &amp; limitations
                        </button>
                    </form>
                </div>
            </div>

            <!-- Ask follow-up question -->
            <div class="assistant-section">
                <h3 class="assistant-section-title">Ask a follow-up question</h3>
                <form th:if="${claimId}" th:action="@{'/followup/' + ${claimId}}" method="post" class="claim-form">
                    <textarea name="question"
                              class="form-textarea"
                              placeholder="Example: Are the sources mostly from one country?"></textarea>
                    <div class="form-footer">
                        <button type="submit" class="btn btn-primary">Ask</button>
                    </div>
                </form>
            </div>

        </div>
    </section>

    <!-- Conversation history -->
    <div th:if="${!#lists.isEmpty(followups)}">
        <h3 class="section-subtitle">Conversation history</h3>
        <div th:each="f : ${followups}">
            <section class="chat-block">
                <div class="chat-label">You (follow-up)</div>
                <div class="chat-bubble chat-bubble-user">
                    <p th:text="${f.question}">Follow-up question</p>
                </div>
            </section>
            <section class="chat-block">
                <div class="chat-label">Assistant</div>
                <div class="chat-bubble chat-bubble-assistant">
                    <p class="assistant-text" th:text="${f.answer}">
                        Follow-up answer text
                    </p>
                </div>
            </section>
        </div>
    </div>

    <!-- Evidence list -->
    <section class="card">
        <h2 class="section-title">Evidence used</h2>

        <div th:if="${#lists.isEmpty(evidenceViews)}">
            <p class="muted"><i>No evidence found in the vector database.</i></p>
        </div>

        <div th:if="${!#lists.isEmpty(evidenceViews)}">
            <ul class="evidence-list">
                <li th:each="e : ${evidenceViews}"
                    class="evidence-item"
                    th:classappend="${e.grouped} ? ' evidence-group' : ''">
                    <div class="evidence-title">
                        <a th:if="${!#strings.isEmpty(e.url)}"
                           th:href="${e.url}"
                           class="evidence-title-link"
                           target="_blank"
                           rel="noopener"
                           th:text="${#strings.isEmpty(e.title) ? 'Untitled article' : e.title}">
                            Article title
                        </a>
                        <span th:if="${#strings.isEmpty(e.url)}"
                              th:text="${#strings.isEmpty(e.title) ? 'Untitled article' : e.title}">
                            Article title
                        </span>
                    </div>
                    <div class="evidence-meta">
                        <span th:if="${!#strings.isEmpty(e.source)}"
                              th:text="'Source: ' + e.source">
                            Source name
                        </span>
                        <span th:if="${e.publishedAt != null}"
                              th:text="'Published: ' + #temporals.format(e.publishedAt, 'yyyy-MM-dd')">
                            Published: date
                        </span>
                        <span th:if="${e.grouped}"
                              th:text="${e.chunkCount} + ' chunks'">
                            3 chunks
                        </span>
                        <a th:if="${!#strings.isEmpty(e.url)}"
                           th:href="${e.url}"
                           class="evidence-link"
                           target="_blank"
                           rel="noopener">
                            Read article
                        </a>
                    </div>
                    <div class="evidence-chunks">
                        <div th:each="chunk : ${e.chunks}" class="evidence-chunk">
                            <p class="evidence-text"
                               th:classappend="${chunk.showToggle} ? ' evidence-text-collapsed' : ''"
                               th:text="${chunk.content}">
                                Article content snippet
                            </p>
                            <button th:if="${chunk.showToggle}"
                                    type="button"
                                    class="evidence-toggle"
                                    aria-expanded="false">
                                Show more
                            </button>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </section>

</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const toggles = document.querySelectorAll('.evidence-toggle');
        toggles.forEach((toggle) => {
            toggle.addEventListener('click', () => {
                const chunk = toggle.closest('.evidence-chunk');
                if (!chunk) return;
                const text = chunk.querySelector('.evidence-text');
                if (!text) return;

                const expanded = chunk.classList.toggle('is-expanded');
                text.classList.toggle('evidence-text-collapsed', !expanded);
                toggle.textContent = expanded ? 'Show less' : 'Show more';
                toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            });
        });
    });
</script>

</body>
</html>
